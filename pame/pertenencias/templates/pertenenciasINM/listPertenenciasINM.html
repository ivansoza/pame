{% extends 'seguridad/baseSeguridadGeneral.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block link %}
    <link rel="stylesheet" href=" {% static 'css/forms/style.css' %}?v1.223SDDDdssdss22D ">
{% endblock link %}

{% block dashboard %}
<a class="btn btn-sm btn-icon1 " href="{% url 'listarExtranjeros' puesta.id %}">
  <i class="fas fa-arrow-left"></i>
</a>

{% endblock dashboard %}
{% block contenido %}
{% include "includes/tituloPertenencias.html" %}
{% include "includes/cardPertenencias.html" %}

<a class='btn btn-verified tooltip-link' 
   data-bs-toggle="tooltip" 
   data-bs-placement="top" 
   data-title="Verifica extranjero" >
   <i class="fas fa-fingerprint"></i>
</a>
<a class='btn btn-custom btn-unverified' 
   data-bs-toggle="tooltip" 
   data-bs-placement="top" 
   href="{% url 'crear_pertenenciasINM' inventario.id puesta.id%}">
   Agregar Pertenencias
</a>


<br>
<br>

<table id="puestaAC-table" class="table table-striped table-bordered display responsive nowrap" style="width:100%">
    <thead>
        <tr>
            <th>Descripcion</th>
            <th>Cantidad</th>
            <th>Observaciones</th>
            <th>Opciones</th>

        </tr>
    </thead>
    <tbody>
        {% for pertenencia in object_list %}
        <tr>
            
            <td>{{ pertenencia.descripcion }}</td>
            <td>{{ pertenencia.cantidad }}</td>
            <td>{{ pertenencia.observaciones }}</td>
            <td>
             <a class="btn btn-sm btn-icon3 tooltip-link btn-unverified"
             href="{% url 'editar_pertenenciasINM' pertenencia.id%}"
             data-title="Editar Pertenencia" >
             <i class="fas fa-edit"></i>
            </a>
                <a class="btn btn-sm btn-icon3 tooltip-link btn-unverified"
                href="{% url 'eliminar_pertenenciasINM' pertenencia.id %}"
                data-title="Eliminar Pertenencia" >
                <i class="fas fa-trash-alt"></i>
                </a>

            </td>
        {% endfor %}
    </tbody>
</table>

<hr>
<a href="{% url 'listarExtranjeros' puesta.id %}" class="btn btn-custom5">Volver</a>
<div class="modal fade" id="agregarpertenencia" role="dialog">
</div>
<div class="modal fade" id="editartpertenencia" role="dialog">

    
</div>

<div class="modal fade" id="eliminarextranjero" role="dialog">
</div>


<div class="modal fade" id="webcamModal" tabindex="-1" aria-labelledby="webcamModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header custom-header-color">
                <h2 class="modal-title">Capturar Foto</h2>
                <button class="close custom-close-button" type="button" data-bs-dismiss="modal" aria-label="close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <span id="timerSpan" style="margin-left: 10px; display: none;">3</span>
            </div>
            <div class="modal-body d-flex justify-content-center align-items-center"> <!-- Agregado flexbox -->
                <div class="capture-container">
                    <!-- Vídeo de la webcam -->
                    <video id="webcam" width="640" height="480" autoplay></video>
                    <canvas id="capturedImage" width="640" height="480" style="display:none;"></canvas>
                    <div id="countdown"
                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #20302B; color: white; font-size: 24px; padding: 10px 20px; border-radius: 5px; display: none;">
                        5</div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="capturarFoto" class="btn btn-custom1">Capturar foto</button>
                <button id="confirmarFoto" class="btn btn-custom2">Confirmar foto</button>
                <button id="nuevaFoto" class="btn btn-custom1">Tomar nueva foto</button>
            </div>
        </div>
    </div>
  </div>
  
{% endblock %}

{% block script %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

<script>
    let verifiedObj = JSON.parse(localStorage.getItem('verifiedTime') || '{}');
    let isVerified = verifiedObj.time && 
                     verifiedObj.extranjeroId === '{{ extranjero_id }}' && 
                     (new Date().getTime() - verifiedObj.time) < 300000;
    
    if (isVerified) {
        // También debemos establecer un nuevo temporizador para manejar el caso en que la página no se recargue
        setTimeout(() => {
            isVerified = false;
            localStorage.removeItem('verifiedTime'); // limpiar el valor almacenado
            bloquearBotones();

        }, 300000 - (new Date().getTime() - verifiedObj.time));
        // Lo elimina
        document.querySelectorAll('.btn-verified').forEach(function(btn) {
            btn.remove();
        });

        document.querySelectorAll('.btn-unverified').forEach(function(btn) {
            btn.classList.remove('btn-unverified');
        });
        
    }else {
        document.querySelectorAll('.btn-verified').forEach(function(btn) {
            btn.addEventListener('click', function(event) {
                event.preventDefault();
                let modal = new bootstrap.Modal(document.getElementById('webcamModal'), {
                    keyboard: false
                });
        
                let video = document.getElementById('webcam');
                let canvas = document.getElementById('capturedImage');

                // Muestra el modal
                resetModal();
                modal.show();
                // Solicita permiso para acceder a la webcam
                navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    // Si se ha resuelto la promesa con éxito, registra en la consola.
                    console.log("Acceso a la webcam concedido.");
                    
                    // Asume que tienes una variable 'video' referenciando tu elemento <video> en el HTML.
                    if (video) {
                        video.srcObject = stream; // Asigna el stream de media obtenido a la propiedad srcObject del elemento <video>.
                        video.play(); // Comienza a reproducir el video.
                    } else {
                        console.error("Error: El elemento <video> no está definido.");
                    }
                })
                .catch(function (error) {
                    // Si hay un error (promesa rechazada), registra el error en la consola.
                    console.error("Error accediendo a la webcam: ", error);
                    console.log("Asegúrate de haber concedido los permisos necesarios para acceder a la webcam.");
                });

                document.getElementById('capturarFoto').onclick = function(event) {
                        event.preventDefault();

                        // Capturar la imagen inmediatamente sin temporizador
                        canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
                        video.style.display = 'none';
                        canvas.style.display = 'block';
                        document.getElementById("capturedImage").style.opacity = "1";

                        document.getElementById('capturarFoto').style.display = 'none';
                        document.getElementById('confirmarFoto').style.display = 'inline-block';
                        document.getElementById('nuevaFoto').style.display = 'inline-block';
                    };


                    document.getElementById('nuevaFoto').onclick = function(event) {
                        event.preventDefault();
                        canvas.style.display = 'none';
                        video.style.display = 'block';
    
                        document.getElementById("capturedImage").style.opacity = "0";
    
                        document.getElementById('capturarFoto').style.display = 'inline-block';
                        document.getElementById('confirmarFoto').style.display = 'none';
                        document.getElementById('nuevaFoto').style.display = 'none';
    
                        if (video.srcObject) {
                            video.srcObject.getTracks().forEach(track => track.stop());
                        }
                        navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
                            video.srcObject = stream;
                        });
                    };


                    document.getElementById('confirmarFoto').onclick = function(event) {
                        event.preventDefault();
                        canvas.toBlob(function(blob) {
                            let file = new File([blob], "foto_webcam.png", {type: "image/png"});
    
                            let formData = new FormData();
                            var extranjeroId = '{{ extranjero_id }}';  // Accediendo al ID del Extranjero en JavaScript
    
                            formData.append('image', file);  // Adjunta la imagen al formulario
                            formData.append('extranjero_id', extranjeroId);  // Añade el id del Extranjero al FormData
    
                            $.ajax({
                                url: '/pertenencias/manejar_imagen/',
                                type: 'POST',
                                data: formData,
                                processData: false,
                                contentType: false,
                                headers: {'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()},
                                success: function(data) {
                                    if (data.match) {
                                        isVerified = true; // Cambiar el estado a verificado
                                        localStorage.setItem('verifiedTime', JSON.stringify({ 
                                            time: new Date().getTime(), 
                                            extranjeroId: '{{ extranjero_id }}' 
                                        }));
                                        
                                        setTimeout(() => {
                                            isVerified = false;
                                            localStorage.removeItem('verifiedTime'); // limpiar el valor almacenado
                                        }, 300000);
                                        Swal.fire({
                                            icon: 'success',
                                            title: '¡Coincidencia Exitosa!',
                                            text: data.similarity 
                                        });
                                        document.querySelectorAll('.btn-unverified').forEach(function(btn) {
                                            btn.classList.remove('btn-unverified');
                                        });
                                        document.querySelectorAll('.btn-verified').forEach(function(btn) {
                                            btn.remove();
                                        });
    
                                    } else {
                                        Swal.fire({
                                            icon: 'warning',
                                            title: '¡No hay coincidencia!',
                                            text: data.similarity, 
                                            confirmButtonText: 'Ok',
                                            confirmButtonColor: '#2A4B41',

                                            
                                        });
                                    }
                                },
                                error: function(error) {
                                    console.error('Error al enviar la imagen:', error.responseText);
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Oops...',
                                        text: '¡Algo salió mal!',
                                        footer: '<a href>¿La persona en la foto no coincide con los datos?</a>'
                                    });
                                }
                            });
    
                            modal.hide();
                            if (video.srcObject) {
                                video.srcObject.getTracks().forEach(track => track.stop());
                            }
                        }, 'image/png');
                    };
    

            });
        });

    }
    function resetModal() {
        let video = document.getElementById('webcam');
        let canvas = document.getElementById('capturedImage');

        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }

        video.removeAttribute('src');
        video.load();

        video.style.display = 'block'; // Mostrar video
        canvas.style.display = 'none'; // Ocultar canvas

        document.getElementById('capturarFoto').style.display = 'inline-block';
        document.getElementById('confirmarFoto').style.display = 'none';
        document.getElementById('nuevaFoto').style.display = 'none';
    }




    document.querySelectorAll('.btn-custom, .btn-icon3').forEach(function(btn) {
        btn.addEventListener('click', function(event) {
            event.preventDefault();

            if (isVerified) {
                let url = btn.getAttribute('href');
                abrir_modal(url);
                document.querySelectorAll('.btn-verified').forEach(function(btn) {
                    btn.remove();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '¡Verifica el Usuario para acceder!',
                    showCancelButton: true, // Esto hará visible el botón de cancelar
                    confirmButtonText: 'Ok',
                    cancelButtonText: 'Verificar', // Este será tu botón adicional
                    cancelButtonColor: '#85364A',
                    confirmButtonColor: '#2A4B41',
                    // Ejemplo de color rojo, reemplaza por el color que prefieras
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Aquí puedes colocar el código que se ejecutará cuando se presione el botón "Ok"
                        console.log('Se presionó el botón Ok');
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        // Aquí puedes colocar el código que se ejecutará solo si se presiona el botón "Verificar"
                        console.log('Se presionó el botón Verificar');
                        document.querySelectorAll('.btn-verified').forEach(function(btn) {
                            btn.click(); // Esto desencadenará el evento de clic en cada botón con la clase 'btn-verified'
                        });
                    } else {
                        // Aquí puedes manejar otros casos de dismiss, como hacer clic fuera del SweetAlert
                        console.log('SweetAlert fue cerrado por otra razón');
                    }
                });
            }
        });
    });

    $('#webcamModal').on('hidden.bs.modal', function() {
        let video = document.getElementById('webcam');
        let canvas = document.getElementById('capturedImage');
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        video.style.display = 'block';
        canvas.style.display = 'none';
        document.getElementById('capturarFoto').style.display = 'inline-block';
        document.getElementById('confirmarFoto').style.display = 'none';
        document.getElementById('nuevaFoto').style.display = 'none';
    });


    function bloquearBotones() {
        document.querySelectorAll('.btn-verified').forEach(function(btn) {
            btn.add(); // Agregar botones de nuevo, o cambiar a estado bloqueado
        });
        document.querySelectorAll('.btn-unverified').forEach(function(btn) {
            btn.classList.add('btn-unverified');
        });
    }
</script>

<script type="text/javascript">
    var $ = jQuery.noConflict();
    function abrir_modal(url){
        $('#agregarpertenencia').load(url, function(){
            $(this).modal('show');
        })
    }
    
</script>

<script type="text/javascript">
    var $ = jQuery.noConflict();
    function abrir_modal_editar(url){
        $('#editartpertenencia').load(url, function(){
            $(this).modal('show');
        })
    }
    
</script>
<script type="text/javascript">
    var $ = jQuery.noConflict();
    function abrir_modal_eliminar(url){
        $('#eliminarextranjero').load(url, function(){
            $(this).modal('show');
        })
    }
    
</script>




{% endblock script %}

